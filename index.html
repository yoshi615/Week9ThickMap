<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>My First MapLibre Map</title>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <select id="basemap-select" style="position:absolute;z-index:1;top:10px;left:10px;">
    <option value="satellite">Googleサテライト</option>
    <option value="positron">Carto Positron</option>
    <option value="darkmatter">Carto Dark Matter</option>
  </select>
  <div id="map"></div>
  <!-- 時系列バー -->
  <div id="timeline-bar">
    <input type="range" id="timeline-range" min="2000" max="2025" value="2010" step="1">
    <span id="timeline-label">2010</span>
    <div id="timeline-ticks">
      <span class="tick" style="left:0%;">2000</span>
      <span class="tick" style="left:25%;">2005</span>
      <span class="tick" style="left:50%;">2012</span>
      <span class="tick" style="left:75%;">2018</span>
      <span class="tick" style="left:100%;">2025</span>
    </div>
  </div>

  <!-- 画像をアニメーションで飛ばすためのimg要素を追加 -->
  <img id="b2-plane" src="B2.png" style="position:absolute; width:48px; height:auto; pointer-events:none; z-index:10; display:none;" />

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    // ベースマップスタイル定義
    const styles = {
      satellite: {
        version: 8,
        sources: {
          'google-satellite': {
            type: 'raster',
            tiles: [
              'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'
            ],
            tileSize: 256,
            attribution: 'Map data &copy; <a href="https://www.google.com/intl/en_us/help/terms_maps/" target="_blank">Google</a>',
            maxzoom: 21
          }
        },
        layers: [
          {
            id: 'google-satellite-layer',
            type: 'raster',
            source: 'google-satellite'
          }
        ]
      },
      positron: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',
      darkmatter: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json'
    };

    // 初期中心・ズーム
    const center = [-30, 40];
    const zoom = 2.2;

    // マップ初期化
    let map = new maplibregl.Map({
      container: 'map',
      style: styles.satellite,
      center: center,
      zoom: zoom
    });

    // マーカー追加関数
    function addMarkers(mapInstance) {
      // アメリカ
      new maplibregl.Marker({ color: 'blue' })
        .setLngLat([-100, 40])
        .setPopup(new maplibregl.Popup().setText('アメリカ'))
        .addTo(mapInstance);
      // イラン
      new maplibregl.Marker({ color: 'red' })
        .setLngLat([53, 32])
        .setPopup(new maplibregl.Popup().setText('イラン'))
        .addTo(mapInstance);
    }

    // アメリカとイランの座標（グローバルに定義）
    const usaLngLat = [-100, 40];
    const iranLngLat = [53, 32];

    // B2飛行機アニメーション関数
    function flyB2Plane() {
      const plane = document.getElementById('b2-plane');
      plane.style.display = 'block';
      plane.style.opacity = '1';

      function lngLatToScreen(lngLat) {
        const p = map.project(lngLat);
        return { x: p.x, y: p.y };
      }
      function getAngle(from, to) {
        const dx = to.x - from.x;
        const dy = to.y - from.y;
        // 画像の「左が上、右が下」なので進行方向-180度
        return Math.atan2(dy, dx) * 180 / Math.PI - 180;
      }

      // スタート・ゴールの画面座標
      let start = lngLatToScreen(usaLngLat);   // アメリカ
      let mid = lngLatToScreen(iranLngLat);    // イラン

      // 直線移動→旋回→直線移動
      let t = 0;
      let phase = 0; // 0:アメリカ→イラン, 1:旋回, 2:イラン→アメリカ

      // 旋回用パラメータ
      const turnSteps = 120; // ←大きくするとより滑らか
      let turnCount = 0;
      let turnCenter = { x: mid.x, y: mid.y }; // イラン上空で旋回
      let turnRadius = 60;
      let turnStartAngle = getAngle(start, mid) * Math.PI / 180;
      let turnEndAngle = turnStartAngle + Math.PI; // 半円旋回

      let angle = getAngle(start, mid);

      function easeInOutSine(x) {
        // 0～1の値をなめらかに補間
        return -(Math.cos(Math.PI * x) - 1) / 2;
      }

      function animate() {
        if (phase === 0) {
          t += 0.008; // ゆっくり
          if (t > 1) {
            t = 1;
            phase = 1;
          }
          // イージングでなめらかに
          const tt = easeInOutSine(t);
          const x = start.x + (mid.x - start.x) * tt;
          const y = start.y + (mid.y - start.y) * tt;
          angle = getAngle({ x, y }, mid);
          plane.style.left = (x - 24) + 'px';
          plane.style.top = (y - 24) + 'px';
          plane.style.transform = `rotate(${angle}deg)`;
        } else if (phase === 1) {
          turnCount++;
          if (turnCount > turnSteps) {
            turnCount = turnSteps;
            phase = 2;
            t = 1;
          }
          // イージングでなめらかに
          const tt = easeInOutSine(turnCount / turnSteps);
          const theta = turnStartAngle + (Math.PI * tt);
          const x = turnCenter.x + turnRadius * Math.cos(theta);
          const y = turnCenter.y + turnRadius * Math.sin(theta);
          angle = theta * 180 / Math.PI - 45;
          plane.style.left = (x - 24) + 'px';
          plane.style.top = (y - 24) + 'px';
          plane.style.transform = `rotate(${angle}deg)`;
        } else if (phase === 2) {
          t -= 0.008;
          if (t < 0) {
            t = 0;
            plane.style.display = 'none';
            return;
          }
          // イージングでなめらかに
          const tt = easeInOutSine(1 - t);
          const x = mid.x + (start.x - mid.x) * tt;
          const y = mid.y + (start.y - mid.y) * tt;
          angle = getAngle({ x, y }, start);
          plane.style.left = (x - 24) + 'px';
          plane.style.top = (y - 24) + 'px';
          plane.style.transform = `rotate(${angle}deg)`;
        }
        requestAnimationFrame(animate);
      }
      animate();
    }

    // 地図ロード時
    map.on('load', () => {
      addMarkers(map);
    });

    // ベースマップ切替時
    document.getElementById('basemap-select').addEventListener('change', function(e) {
      const selected = e.target.value;
      map.setStyle(styles[selected]);
      map.once('styledata', () => {
        map.setCenter(center);
        map.setZoom(zoom);
        addMarkers(map);
      });
    });

    // 2005年に合わせたら飛行機を飛ばす
    const timelineRange = document.getElementById('timeline-range');
    const timelineLabel = document.getElementById('timeline-label');
    timelineRange.addEventListener('input', function() {
      timelineLabel.textContent = timelineRange.value;
      if (timelineRange.value === "2005") {
        flyB2Plane();
      } else {
        document.getElementById('b2-plane').style.display = 'none';
      }
    });
  </script>
  <style>
    #map {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
    }
    #timeline-bar {
      position: absolute;
      left: 20px;
      bottom: 20px;
      background: rgba(255,255,255,0.95);
      padding: 14px 20px 30px 20px;
      border-radius: 12px;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 10px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.13);
      border: 1.5px solid #bbb;
    }
    #timeline-range {
      width: 260px;
      accent-color: #1976d2;
      height: 4px;
      margin-bottom: 2px;
    }
    #timeline-label {
      font-weight: bold;
      min-width: 40px;
      text-align: center;
      margin-left: 12px;
      color: #1976d2;
      font-size: 1.1em;
    }
    #timeline-ticks {
      position: relative;
      width: 260px;
      height: 18px;
      margin-top: 4px;
    }
    #timeline-ticks .tick {
      position: absolute;
      top: 0;
      transform: translateX(-50%);
      font-size: 13px;
      color: #333;
      pointer-events: none;
      user-select: none;
      font-family: 'Segoe UI', sans-serif;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    /* スライダーのつまみを大きく・目立たせる */
    #timeline-range::-webkit-slider-thumb {
      width: 18px;
      height: 18px;
      background: #1976d2;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
      cursor: pointer;
      -webkit-appearance: none;
      appearance: none;
    }
    #timeline-range::-moz-range-thumb {
      width: 18px;
      height: 18px;
      background: #1976d2;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
      cursor: pointer;
    }
    #timeline-range::-ms-thumb {
      width: 18px;
      height: 18px;
      background: #1976d2;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.18);
      cursor: pointer;
    }
    /* スライダーのバー部分 */
    #timeline-range::-webkit-slider-runnable-track {
      height: 6px;
      background: linear-gradient(90deg, #1976d2 0%, #90caf9 100%);
      border-radius: 3px;
    }
    #timeline-range::-ms-fill-lower {
      background: #1976d2;
    }
    #timeline-range::-ms-fill-upper {
      background: #90caf9;
    }
  </style>
</body>
</html>